{
  "audit_metadata": {
    "date": "2024-12-19",
    "target": "Manager POS → Manager Analytics Conversion",
    "scope": "Full codebase audit for conversion planning"
  },
  "file_map": {
    "controllers": [
      "app/Controllers/POSController.php",
      "app/Controllers/DashboardController.php"
    ],
    "models": [
      "app/Models/POSSale.php",
      "app/Models/POSSaleItem.php",
      "app/Models/Product.php",
      "app/Models/Customer.php",
      "app/Models/Swap.php",
      "app/Models/Repair.php",
      "app/Models/CompanyModule.php"
    ],
    "views": [
      "app/Views/pos_content.php",
      "app/Views/pos_sales_history.php",
      "app/Views/analytics.php"
    ],
    "routes": [
      "routes/web.php"
    ],
    "javascript_assets": [
      "Embedded in pos_content.php (lines 2029-3220)",
      "Chart.js CDN reference (line 159 in analytics.php)"
    ]
  },
  "routes": {
    "web": [
      "GET /dashboard/pos → POSController::index()",
      "GET /dashboard/pos/sales-history → POSController::salesHistory()",
      "GET /pos/receipt/{id} → POSController::generateReceipt($id)",
      "GET /pos/report/print → POSController::reportPrint()"
    ],
    "api": [
      "GET /api/pos/sales → POSController::apiSales()",
      "GET /api/pos/sale/{id} → POSController::apiSaleDetails($id)",
      "GET /api/pos/stats → POSController::apiStats()",
      "GET /api/pos/inventory-stats → POSController::apiInventoryStats()",
      "GET /api/pos/audit-data → POSController::apiAuditData()",
      "GET /api/pos/top-products → POSController::apiTopSellingProducts()",
      "GET /api/dashboard/company-metrics → DashboardController::apiCompanyMetrics()",
      "GET /api/dashboard/sales-metrics → DashboardController::apiSalesMetrics()",
      "DELETE /api/pos/sale/{id} → POSController::deleteSale($id)",
      "POST /api/pos/sale/{id}/delete → POSController::deleteSale($id)",
      "DELETE /api/pos/sales/bulk → POSController::bulkDeleteSales()",
      "POST /api/pos/sales/bulk-delete → POSController::bulkDeleteSales()"
    ],
    "product_search": [
      "GET /api/products/search → ProductsController::search() (via Product::search())"
    ],
    "customer_search": [
      "GET /api/customers/search → CustomerController::search() (via Customer::search())"
    ]
  },
  "data_flow": {
    "pos_index": {
      "models": ["Product", "Customer", "CompanyModule"],
      "tables": ["products", "customers", "company_modules"],
      "queries": [
        "SELECT * FROM products WHERE company_id = ? LIMIT 200",
        "SELECT * FROM customers WHERE company_id = ? LIMIT 100",
        "SELECT module_key FROM company_modules WHERE company_id = ? AND enabled = 1"
      ]
    },
    "api_stats": {
      "models": ["POSSale"],
      "tables": ["pos_sales"],
      "queries": [
        "SELECT COUNT(*), SUM(final_amount) FROM pos_sales WHERE company_id = ? AND DATE(created_at) BETWEEN ? AND ?",
        "SELECT COUNT(*), SUM(final_amount) FROM pos_sales WHERE company_id = ? AND DATE(created_at) = CURDATE()",
        "SELECT COUNT(*), SUM(final_amount) FROM pos_sales WHERE company_id = ? AND MONTH(created_at) = MONTH(CURDATE())"
      ]
    },
    "api_audit_data": {
      "models": ["POSSale", "POSSaleItem", "Swap", "Repair", "Product"],
      "tables": ["pos_sales", "pos_sale_items", "swaps", "repairs", "products", "customers", "users", "brands"],
      "queries": [
        "SELECT ps.*, u.full_name as cashier_name, COUNT(psi.id) as item_count FROM pos_sales ps LEFT JOIN users u ON ps.created_by_user_id = u.id LEFT JOIN pos_sale_items psi ON ps.id = psi.pos_sale_id WHERE ps.company_id = ? GROUP BY ps.id ORDER BY ps.created_at DESC LIMIT ?",
        "SELECT s.*, c.full_name as customer_name FROM swaps s LEFT JOIN customers c ON s.customer_id = c.id WHERE s.company_id = ? ORDER BY s.created_at DESC LIMIT ?",
        "SELECT r.*, c.full_name as customer_name FROM repairs r LEFT JOIN customers c ON r.customer_id = c.id WHERE r.company_id = ? ORDER BY r.created_at DESC LIMIT ?",
        "SELECT psi.item_description, SUM(psi.quantity) as total_sold, SUM(psi.total_price) as total_revenue FROM pos_sale_items psi INNER JOIN pos_sales ps ON psi.pos_sale_id = ps.id WHERE ps.company_id = ? AND ps.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) GROUP BY psi.item_description ORDER BY total_sold DESC LIMIT ?"
      ]
    }
  },
  "current_metrics": {
    "pos_manager_view": {
      "today_revenue": {
        "source": "pos_sales.final_amount",
        "aggregation": "SUM(final_amount)",
        "filter": "DATE(created_at) = CURDATE() AND company_id = ?",
        "api_endpoint": "/api/pos/stats?date_from={today}&date_to={today}"
      },
      "today_sales": {
        "source": "pos_sales.id",
        "aggregation": "COUNT(*)",
        "filter": "DATE(created_at) = CURDATE() AND company_id = ?"
      },
      "monthly_sales": {
        "source": "pos_sales.id",
        "aggregation": "COUNT(*)",
        "filter": "MONTH(created_at) = MONTH(CURDATE()) AND YEAR(created_at) = YEAR(CURDATE()) AND company_id = ?"
      },
      "monthly_revenue": {
        "source": "pos_sales.final_amount",
        "aggregation": "SUM(final_amount)",
        "filter": "MONTH(created_at) = MONTH(CURDATE()) AND company_id = ?"
      },
      "total_products": {
        "source": "products.id",
        "aggregation": "COUNT(*)",
        "filter": "company_id = ?",
        "endpoint": "/api/pos/inventory-stats"
      },
      "in_stock_products": {
        "source": "products.quantity",
        "aggregation": "COUNT(*) WHERE quantity > 0",
        "filter": "company_id = ? AND quantity > 0"
      },
      "low_stock_products": {
        "source": "products.quantity",
        "aggregation": "COUNT(*) WHERE quantity > 0 AND quantity < threshold",
        "filter": "company_id = ? AND quantity > 0 AND quantity < 10"
      },
      "out_of_stock_products": {
        "source": "products.quantity",
        "aggregation": "COUNT(*) WHERE quantity = 0",
        "filter": "company_id = ? AND quantity = 0"
      }
    },
    "dashboard_metrics": {
      "today_revenue": "pos_sales.final_amount WHERE DATE(created_at) = CURDATE()",
      "today_sales": "COUNT(*) FROM pos_sales WHERE DATE(created_at) = CURDATE()",
      "monthly_revenue": "SUM(final_amount) FROM pos_sales WHERE MONTH(created_at) = MONTH(CURDATE())",
      "monthly_sales": "COUNT(*) FROM pos_sales WHERE MONTH(created_at) = MONTH(CURDATE())",
      "active_repairs": "COUNT(*) FROM repairs WHERE status IN ('PENDING','IN_PROGRESS')",
      "monthly_repairs": "COUNT(*) FROM repairs WHERE MONTH(created_at) = MONTH(CURDATE())",
      "pending_swaps": "COUNT(*) FROM swaps WHERE swap_status = 'PENDING'",
      "monthly_swaps": "COUNT(*) FROM swaps WHERE MONTH(created_at) = MONTH(CURDATE())"
    },
    "missing_metrics": [
      "profit_margin (revenue - cost)",
      "losses (damaged/returned items)",
      "swap_profit (from swap_profit_links table)",
      "revenue_by_day (time series)",
      "revenue_by_product_category",
      "average_transaction_value",
      "customer_lifetime_value",
      "top_customers_by_revenue"
    ]
  },
  "exports": {
    "existing": {
      "pdf_print": {
        "route": "/pos/report/print",
        "method": "POSController::reportPrint()",
        "format": "HTML (print-friendly, browser Save as PDF)",
        "tables": ["pos_sales"],
        "query": "SELECT * FROM pos_sales WHERE company_id = ? AND DATE(created_at) BETWEEN ? AND ?",
        "limitations": "No programmatic PDF generation, no Excel/CSV"
      },
      "csv_client_side": {
        "location": "app/Views/repairs_reports.php (lines 198-230)",
        "format": "Client-side CSV (JavaScript)",
        "scope": "Repairs reports only, not POS/sales"
      }
    },
    "missing": [
      "CSV export for sales",
      "CSV export for products",
      "CSV export for swaps",
      "CSV export for repairs",
      "CSV export for customers",
      "Excel export (XLSX)",
      "Server-side PDF generation (wkhtmltopdf/dompdf)"
    ]
  },
  "search_capability": {
    "product_search": {
      "endpoint": "Product::search($company_id, $query, $category_id)",
      "fields": ["products.name", "products.product_id (SKU)"],
      "query": "SELECT * FROM products WHERE company_id = ? AND name LIKE ? ORDER BY name ASC LIMIT 50",
      "indexes": ["idx_company (company_id)", "INDEX on name (recommended: FULLTEXT)"]
    },
    "customer_search": {
      "endpoint": "Customer::search($searchTerm, $companyId, $limit)",
      "fields": ["customers.full_name", "customers.phone_number"],
      "query": "SELECT * FROM customers WHERE company_id = ? AND (full_name LIKE ? OR phone_number LIKE ?) ORDER BY full_name ASC LIMIT ?",
      "indexes": ["idx_company (company_id)", "idx_phone (phone_number)", "INDEX on full_name (recommended)"]
    },
    "sale_search": {
      "exists": false,
      "needed": "Search by sale_id, customer_name, date_range",
      "recommended_query": "SELECT * FROM pos_sales ps LEFT JOIN customers c ON ps.customer_id = c.id WHERE ps.company_id = ? AND (ps.id = ? OR ps.unique_id LIKE ? OR c.full_name LIKE ? OR c.phone_number LIKE ?) AND DATE(ps.created_at) BETWEEN ? AND ?"
    },
    "imei_search": {
      "exists": false,
      "needed": "Search products by IMEI",
      "recommended_query": "SELECT * FROM products WHERE company_id = ? AND imei = ? OR imei LIKE ?",
      "recommended_index": "INDEX idx_imei (imei)"
    },
    "trace_by_imei": {
      "exists": false,
      "needed": "Full history trace (sale, swap, repair, inventory location)",
      "recommended_implementation": "See trace_feature_design section"
    }
  },
  "performance": {
    "expensive_queries": [
      {
        "location": "DashboardController::apiSalesMetrics()",
        "query": "Multiple JOINs across pos_sales, pos_sale_items, products, brands",
        "issue": "N+1 pattern, multiple subqueries",
        "recommendation": "Single query with proper JOINs, add indexes"
      },
      {
        "location": "POSController::apiAuditData()",
        "query": "Multiple sequential queries for recent_sales, recent_repairs, recent_swaps, top_products",
        "issue": "Not parallelized, could be optimized",
        "recommendation": "Use async/parallel queries or combine into single endpoint"
      }
    ],
    "missing_indexes": [
      "pos_sales: INDEX idx_company_created (company_id, created_at)",
      "pos_sales: INDEX idx_company_date (company_id, DATE(created_at))",
      "pos_sale_items: INDEX idx_sale_item (pos_sale_id, item_id)",
      "products: FULLTEXT INDEX ft_name (name)",
      "customers: INDEX idx_name (full_name)",
      "products: INDEX idx_imei (imei) WHERE imei IS NOT NULL"
    ],
    "caching_opportunities": [
      {
        "metric": "company dashboard overview",
        "cache_key": "company:{id}:dashboard:overview:{date}",
        "ttl": 300
      },
      {
        "metric": "inventory_stats",
        "cache_key": "company:{id}:inventory:stats",
        "ttl": 600
      },
      {
        "metric": "top_products",
        "cache_key": "company:{id}:products:top:{days}",
        "ttl": 1800
      }
    ]
  },
  "security": {
    "company_id_enforcement": {
      "pos_sales": "✓ Enforced in POSSale::findByCompany(), POSController methods",
      "products": "✓ Enforced in Product::findByCompany(), Product::search()",
      "customers": "✓ Enforced in Customer::search(), Customer::findByCompany()",
      "swaps": "✓ Enforced in Swap::findByCompany()",
      "repairs": "✓ Enforced in Repair::findByCompany()"
    },
    "potential_leakage": [
      {
        "endpoint": "POSSale::findById($id)",
        "issue": "No company_id check",
        "severity": "HIGH",
        "location": "app/Models/POSSale.php:100",
        "recommendation": "Always use findByCompany() or add company_id check"
      },
      {
        "endpoint": "Product::quickSearch()",
        "issue": "No company_id filter",
        "severity": "MEDIUM",
        "location": "app/Models/Customer.php:250",
        "recommendation": "Remove or add company_id filter"
      }
    ]
  },
  "module_toggle_integration": {
    "current_hooks": [
      {
        "file": "app/Controllers/POSController.php",
        "line": 100,
        "module": "pos_sales",
        "check": "CompanyModule::isEnabled($companyId, 'pos_sales')"
      },
      {
        "file": "app/Controllers/DashboardController.php",
        "line": 403,
        "module": "pos_sales",
        "check": "in_array('pos_sales', $enabledModuleKeys)"
      },
      {
        "file": "app/Controllers/DashboardController.php",
        "line": 443,
        "module": "repairs",
        "check": "in_array('repairs', $enabledModuleKeys)"
      },
      {
        "file": "app/Controllers/DashboardController.php",
        "line": 465,
        "module": "swap",
        "check": "in_array('swap', $enabledModuleKeys)"
      }
    ],
    "analytics_widget_hooks": [
      {
        "widget": "Sales Revenue Card",
        "module": "pos_sales",
        "hook_location": "ManagerAnalyticsController::overview() - check before including in response"
      },
      {
        "widget": "Swap Metrics",
        "module": "swap",
        "hook_location": "ManagerAnalyticsController::overview() - conditionally hide if disabled"
      },
      {
        "widget": "Repair Metrics",
        "module": "repairs",
        "hook_location": "ManagerAnalyticsController::overview() - conditionally hide if disabled"
      }
    ]
  },
  "ui_components": {
    "chart_libraries": [
      {
        "name": "Chart.js",
        "version": "3.9.1",
        "location": "app/Views/analytics.php:159",
        "usage": "CDN loaded, used for revenue/transaction charts"
      }
    ],
    "css_frameworks": ["TailwindCSS (utility classes)"],
    "icons": ["Font Awesome 5 (fas classes)"],
    "reusable_components": [
      "Metric cards (bg-white rounded-lg shadow p-6)",
      "Date range picker (posDateFrom/posDateTo inputs)",
      "Export buttons (btnExportPdf)"
    ]
  },
  "suggested_analytics_design": {
    "widgets": [
      {
        "type": "KPI Card",
        "name": "Today's Revenue",
        "sql": "SELECT SUM(final_amount) FROM pos_sales WHERE company_id = ? AND DATE(created_at) = CURDATE()",
        "route": "GET /api/analytics/overview",
        "cache_key": "company:{id}:analytics:today:revenue",
        "cache_ttl": 300,
        "module_dependency": "pos_sales"
      },
      {
        "type": "KPI Card",
        "name": "Total Profit",
        "sql": "SELECT SUM(final_amount - COALESCE(total_cost, final_amount * 0.8)) FROM pos_sales WHERE company_id = ? AND DATE(created_at) BETWEEN ? AND ?",
        "route": "GET /api/analytics/profit",
        "cache_key": "company:{id}:analytics:profit:{date_from}:{date_to}",
        "cache_ttl": 600,
        "module_dependency": "pos_sales"
      },
      {
        "type": "Line Chart",
        "name": "Revenue Trend (7 days)",
        "sql": "SELECT DATE(created_at) as date, SUM(final_amount) as revenue FROM pos_sales WHERE company_id = ? AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) GROUP BY DATE(created_at) ORDER BY date ASC",
        "route": "GET /api/analytics/revenue-trend?days=7",
        "cache_key": "company:{id}:analytics:revenue:trend:7d",
        "cache_ttl": 900,
        "module_dependency": "pos_sales"
      },
      {
        "type": "Bar Chart",
        "name": "Top Products",
        "sql": "SELECT p.name, SUM(psi.quantity) as units_sold, SUM(psi.total_price) as revenue FROM pos_sale_items psi INNER JOIN pos_sales ps ON psi.pos_sale_id = ps.id LEFT JOIN products p ON psi.item_id = p.id WHERE ps.company_id = ? AND ps.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) GROUP BY p.id, p.name ORDER BY units_sold DESC LIMIT 10",
        "route": "GET /api/analytics/top-products?days=30&limit=10",
        "cache_key": "company:{id}:analytics:top-products:30d",
        "cache_ttl": 1800,
        "module_dependency": "pos_sales"
      },
      {
        "type": "Table",
        "name": "Recent Transactions",
        "sql": "SELECT ps.*, c.full_name as customer_name, COUNT(psi.id) as item_count FROM pos_sales ps LEFT JOIN customers c ON ps.customer_id = c.id LEFT JOIN pos_sale_items psi ON ps.id = psi.pos_sale_id WHERE ps.company_id = ? GROUP BY ps.id ORDER BY ps.created_at DESC LIMIT 20",
        "route": "GET /api/analytics/recent-transactions?limit=20",
        "cache_key": "company:{id}:analytics:recent:transactions",
        "cache_ttl": 300,
        "module_dependency": "pos_sales"
      },
      {
        "type": "KPI Card",
        "name": "Swap Profit",
        "sql": "SELECT SUM(final_profit) FROM swap_profit_links WHERE swap_id IN (SELECT id FROM swaps WHERE company_id = ?) AND status = 'finalized' AND DATE(finalized_at) BETWEEN ? AND ?",
        "route": "GET /api/analytics/swap-profit?date_from=&date_to=",
        "cache_key": "company:{id}:analytics:swap-profit:{date_from}:{date_to}",
        "cache_ttl": 600,
        "module_dependency": "swap"
      }
    ],
    "filters": [
      "Date range (from/to)",
      "Product category",
      "Customer name/phone",
      "Sale ID",
      "Payment method"
    ]
  },
  "export_design": {
    "csv_sales": {
      "sql": "SELECT ps.id, ps.unique_id, ps.created_at, c.full_name as customer, ps.final_amount, ps.payment_method, GROUP_CONCAT(psi.item_description SEPARATOR '; ') as items FROM pos_sales ps LEFT JOIN customers c ON ps.customer_id = c.id LEFT JOIN pos_sale_items psi ON ps.id = psi.pos_sale_id WHERE ps.company_id = ? AND DATE(ps.created_at) BETWEEN ? AND ? GROUP BY ps.id ORDER BY ps.created_at DESC",
      "strategy": "Streaming: Use fputcsv() with output buffering, chunk by 1000 rows",
      "memory_safe": true,
      "route": "GET /api/analytics/export/sales?format=csv&date_from=&date_to="
    },
    "csv_products": {
      "sql": "SELECT id, product_id as sku, name, category, brand, price, cost, quantity, status FROM products WHERE company_id = ? ORDER BY name ASC",
      "strategy": "Streaming: fputcsv() chunked",
      "memory_safe": true,
      "route": "GET /api/analytics/export/products?format=csv"
    },
    "pdf_report": {
      "strategy": "wkhtmltopdf or dompdf",
      "template": "app/Views/reports/sales_report.php",
      "route": "GET /api/analytics/export/report?format=pdf&date_from=&date_to=",
      "library": "dompdf/dompdf (recommended for PHP)"
    },
    "excel_export": {
      "strategy": "PhpSpreadsheet library",
      "route": "GET /api/analytics/export/sales?format=xlsx",
      "memory_safe": "Use streaming writer for large datasets"
    }
  },
  "trace_feature_design": {
    "endpoint": "GET /api/analytics/trace",
    "search_fields": ["imei", "product_id", "sku", "customer_phone", "customer_name", "sale_id"],
    "sql_example": "SELECT 'sale' as type, ps.id, ps.created_at, ps.final_amount, c.full_name as customer, psi.item_description FROM pos_sales ps LEFT JOIN pos_sale_items psi ON ps.id = psi.pos_sale_id LEFT JOIN customers c ON ps.customer_id = c.id LEFT JOIN products p ON psi.item_id = p.id WHERE ps.company_id = ? AND (p.imei = ? OR p.product_id = ? OR c.phone_number = ?) UNION SELECT 'swap' as type, s.id, s.created_at, s.total_value as amount, c.full_name as customer, cp.brand || ' ' || cp.model as item FROM swaps s LEFT JOIN customers c ON s.customer_id = c.id LEFT JOIN customer_products cp ON s.customer_product_id = cp.id WHERE s.company_id = ? AND (cp.imei = ? OR c.phone_number = ?) UNION SELECT 'repair' as type, r.id, r.created_at, r.total_cost as amount, c.full_name as customer, r.phone_description as item FROM repairs r LEFT JOIN customers c ON r.customer_id = c.id WHERE r.company_id = ? AND (r.imei = ? OR c.phone_number = ?) UNION SELECT 'inventory' as type, p.id, p.created_at, p.price as amount, NULL as customer, p.name as item FROM products p WHERE p.company_id = ? AND (p.imei = ? OR p.product_id = ?) ORDER BY created_at DESC",
    "response_schema": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "type": "sale|swap|repair|inventory",
          "id": "integer",
          "date": "datetime",
          "amount": "float",
          "customer": "string|null",
          "item": "string",
          "location": "string|null",
          "status": "string|null"
        }
      }
    }
  },
  "migration_steps": {
    "step_1": {
      "action": "Create ManagerAnalyticsController",
      "file": "app/Controllers/ManagerAnalyticsController.php",
      "methods": ["index()", "overview()", "export()", "trace()"]
    },
    "step_2": {
      "action": "Create analytics view",
      "file": "app/Views/manager_analytics.php",
      "based_on": "app/Views/pos_content.php (manager metrics section)"
    },
    "step_3": {
      "action": "Add routes",
      "file": "routes/web.php",
      "routes": [
        "GET /dashboard/analytics → ManagerAnalyticsController::index() [for managers]",
        "GET /api/analytics/overview → ManagerAnalyticsController::overview()",
        "GET /api/analytics/export/{type} → ManagerAnalyticsController::export()",
        "GET /api/analytics/trace → ManagerAnalyticsController::trace()"
      ]
    },
    "step_4": {
      "action": "Modify POS route",
      "file": "routes/web.php",
      "change": "GET /dashboard/pos → Check role: if manager AND manager_can_sell=false, redirect to /dashboard/analytics"
    },
    "step_5": {
      "action": "Add database indexes",
      "migration_file": "database/migrations/add_analytics_indexes.sql",
      "indexes": [
        "CREATE INDEX idx_pos_sales_company_created ON pos_sales(company_id, created_at)",
        "CREATE INDEX idx_pos_sale_items_sale_item ON pos_sale_items(pos_sale_id, item_id)",
        "CREATE FULLTEXT INDEX ft_products_name ON products(name)",
        "CREATE INDEX idx_products_imei ON products(imei) WHERE imei IS NOT NULL",
        "CREATE INDEX idx_customers_name ON customers(full_name)"
      ]
    },
    "step_6": {
      "action": "Implement caching",
      "file": "app/Services/CacheService.php (create if missing)",
      "strategy": "Redis or file-based cache with TTL"
    }
  },
  "testing_checklist": {
    "unit_tests": [
      "ManagerAnalyticsController::overview() returns correct metrics",
      "CompanyModule::isEnabled() checks work for analytics widgets",
      "Export functions generate correct CSV/PDF",
      "Trace function finds items across all tables"
    ],
    "integration_tests": [
      "Analytics API respects company_id isolation",
      "Module toggles hide/show correct widgets",
      "Date filters work correctly",
      "Export downloads are company-scoped"
    ],
    "end_to_end_tests": [
      "Manager sees analytics page (not POS) when manager_can_sell=false",
      "Salesperson sees POS page (not analytics)",
      "Exports download correct data",
      "Trace feature returns complete history"
    ]
  },
  "backwards_compatibility": {
    "pos_for_salespeople": "✓ Keep /dashboard/pos route for salesperson role",
    "existing_api_endpoints": "✓ Keep all /api/pos/* endpoints for backward compatibility",
    "manager_with_sell_permission": "✓ If manager_can_sell=true, show POS (not analytics)",
    "minimal_changes": "Only modify /dashboard/pos route to redirect managers (when appropriate)"
  },
  "sample_code_artifacts": {
    "sql_aggregates": {
      "today_sales": "SELECT COUNT(*) as count, SUM(final_amount) as revenue, AVG(final_amount) as avg_sale FROM pos_sales WHERE company_id = ? AND DATE(created_at) = CURDATE()",
      "profit": "SELECT SUM(final_amount - COALESCE((SELECT SUM(psi.quantity * COALESCE(p.cost, p.cost_price, 0)) FROM pos_sale_items psi LEFT JOIN products p ON psi.item_id = p.id WHERE psi.pos_sale_id = ps.id), final_amount * 0.8)) as profit FROM pos_sales ps WHERE ps.company_id = ? AND DATE(ps.created_at) BETWEEN ? AND ?",
      "swap_profit": "SELECT COALESCE(SUM(spl.final_profit), 0) as total_profit FROM swap_profit_links spl INNER JOIN swaps s ON spl.swap_id = s.id WHERE s.company_id = ? AND spl.status = 'finalized' AND DATE(spl.finalized_at) BETWEEN ? AND ?"
    },
    "controller_skeleton": "See MANAGER_ANALYTICS_IMPLEMENTATION.md",
    "trace_query": "See trace_feature_design section above",
    "export_endpoint_skeleton": "See MANAGER_ANALYTICS_IMPLEMENTATION.md"
  },
  "missing_endpoints": [
    {
      "endpoint": "GET /api/analytics/revenue-by-day",
      "purpose": "Time series revenue data for charts",
      "sql": "SELECT DATE(created_at) as date, SUM(final_amount) as revenue, COUNT(*) as sales_count FROM pos_sales WHERE company_id = ? AND DATE(created_at) BETWEEN ? AND ? GROUP BY DATE(created_at) ORDER BY date ASC"
    },
    {
      "endpoint": "GET /api/analytics/profit-margin",
      "purpose": "Calculate profit margins",
      "sql": "SELECT SUM(final_amount) as revenue, SUM(COALESCE(total_cost, final_amount * 0.8)) as cost, (SUM(final_amount) - SUM(COALESCE(total_cost, final_amount * 0.8))) / SUM(final_amount) * 100 as margin_pct FROM pos_sales WHERE company_id = ? AND DATE(created_at) BETWEEN ? AND ?"
    }
  ]
}

